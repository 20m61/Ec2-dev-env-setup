# ğŸŒ± EC2 Dev Environment Template with CDK + GitHub Actions

Amazon EC2ï¼ˆGravitonï¼‰ã¨ AWS CDKã€GitHub Actions ã‚’ä½¿ã£ã¦ã€ã‚³ã‚¹ãƒ‘æœ€å¼·ãƒ»å¿«é©ãƒ»ã‚»ã‚­ãƒ¥ã‚¢ãªé–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

## âœ… ç‰¹å¾´

- ğŸ’» **Graviton (ARM) ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹** ã‚’åˆ©ç”¨ã—ãŸã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„é–‹ç™ºç’°å¢ƒ
- ğŸ” IAM ãƒ­ãƒ¼ãƒ«ã¨ SSM + S3 ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è‡ªå‹•è¨­å®š
- ğŸ“¦ 100GB EBS ä»˜ãï¼ˆ`gp3`ï¼‰ã§ `git worktree` ã‚„ Docker ã«ã‚‚å¯¾å¿œ
- âš™ï¸ CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã€GitHub Actions ã§ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–
- ğŸª„ ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é‹ç”¨ã«ã‚‚å¯¾å¿œå¯èƒ½ï¼ˆå¾Œè¿°ï¼‰

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```bash
.
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ dev-env.ts
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ dev-env-stack.ts
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ user-data.sh
â”œâ”€â”€ .github/workflows/deploy.yml
â”œâ”€â”€ cdk.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ tsconfig.json
```

---

## ğŸ› ï¸ EC2 ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ä¸»ãªãƒ„ãƒ¼ãƒ«ã¨ä½¿ã„æ–¹

æœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ã€AWS CLIï¼ˆawscliï¼‰ã«åŠ ãˆã€ä»¥ä¸‹ã®AWSé–¢é€£ã‚³ãƒãƒ³ãƒ‰ã‚‚è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

- session-manager-plugin
- amazon-ssm-agent
- ecs-cli
- eksctl
- aws-cdk
- aws-sam-cli

ã“ã‚Œã«ã‚ˆã‚Šã€EC2ä¸Šã§å¹…åºƒã„AWSã‚µãƒ¼ãƒ“ã‚¹ã®æ“ä½œã‚„é–‹ç™ºãŒå¯èƒ½ã§ã™ã€‚

| ãƒ„ãƒ¼ãƒ«å               | ä¸»ãªç”¨é€”ãƒ»ä½¿ã„æ–¹ä¾‹                                           |
| ---------------------- | ------------------------------------------------------------ | ----- |
| git                    | ãƒãƒ¼ã‚¸ãƒ³ç®¡ç†ã€‚`git clone`, `git worktree` ãªã©               |
| docker                 | ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œã€‚`docker run`, `docker build` ãªã©              |
| docker compose         | è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†ã€‚`docker compose up -d` ãªã©              |
| awscli                 | AWS æ“ä½œ CLIã€‚`aws s3 ls`, `aws ec2 describe-instances` ãªã© |
| session-manager-plugin | SSMã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ç”¨CLIã€‚`session-manager-plugin`       |
| amazon-ssm-agent       | SSMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚EC2ã‹ã‚‰SSMæ“ä½œç”¨                            |
| ecs-cli                | Amazon ECS CLIã€‚`ecs-cli`                                    |
| eksctl                 | Amazon EKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç®¡ç†CLIã€‚`eksctl`                       |
| aws-cdk                | AWS CDK CLIã€‚`cdk deploy` ãªã©                               |
| aws-sam-cli            | AWS SAM CLIã€‚`sam build` `sam deploy` ãªã©                   |
| code-server            | ãƒ–ãƒ©ã‚¦ã‚¶ã§ VSCodeã€‚`http://<EC2-IP>:8080` ã§ã‚¢ã‚¯ã‚»ã‚¹         |
| gh CLI                 | GitHub æ“ä½œ CLIã€‚`gh repo clone`, `gh pr create` ãªã©        |
| gh copilot CLI         | GitHub Copilot CLI æ‹¡å¼µã€‚`gh copilot` ã‚³ãƒãƒ³ãƒ‰               |
| claude CLI             | Claude API åˆ©ç”¨ CLIã€‚`claude chat` ãªã©                      |
| zsh                    | é«˜æ©Ÿèƒ½ã‚·ã‚§ãƒ«ã€‚`chsh -s $(which zsh)` ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåŒ–          |
| tmux                   | ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å¤šé‡åŒ–ã€‚`tmux` ã§èµ·å‹•ã€`Ctrl+b` ã§æ“ä½œ             |
| htop                   | ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ã€‚`htop`                                         |
| jq                     | JSON æ•´å½¢ãƒ»æŠ½å‡ºã€‚`cat file.json                              | jq .` |
| tree                   | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ è¡¨ç¤ºã€‚`tree`                                 |
| unzip                  | zip è§£å‡ã€‚`unzip file.zip`                                   |
| make                   | ãƒ“ãƒ«ãƒ‰è‡ªå‹•åŒ–ã€‚`make`                                         |
| gcc                    | C/C++ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã€‚`gcc main.c -o main`                        |
| python3                | Python å®Ÿè¡Œã€‚`python3 script.py`                             |
| nodejs                 | Node.js å®Ÿè¡Œã€‚`node app.js`                                  |
| n                      | Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€‚`sudo n lts` ã§ LTS ç‰ˆã«åˆ‡æ›¿         |
| yarn                   | Node.js ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã€‚`yarn install`, `yarn run`           |
| corepack               | Node.js å…¬å¼ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ©ãƒƒãƒ‘ãƒ¼ã€‚`corepack enable`        |
| fzf                    | é«˜é€Ÿãƒ•ã‚¡ã‚¸ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ã€‚`fzf`                              |
| bat                    | cat ã®é«˜æ©Ÿèƒ½ç‰ˆã€‚`bat file.txt`                               |
| ripgrep                | é«˜é€Ÿ grepã€‚`rg pattern`                                      |
| neovim                 | é«˜æ©Ÿèƒ½ã‚¨ãƒ‡ã‚£ã‚¿ã€‚`nvim`                                       |

> ãã‚Œãã‚Œã®è©³ç´°ãªä½¿ã„æ–¹ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ `--help` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç¢ºèªã§ãã¾ã™ã€‚

---

## ğŸ“ å‰ææ¡ä»¶

- AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆEC2, S3, IAM, CloudFormationç­‰ãŒåˆ©ç”¨å¯èƒ½ãªæ¨©é™ï¼‰
- macOS/Linux/Windows ã„ãšã‚Œã‹ã®PC
- Node.jsï¼ˆæ¨å¥¨: v18ä»¥ä¸Šï¼‰
- npmï¼ˆNode.jsã«åŒæ¢±ã€æ¨å¥¨: v9ä»¥ä¸Šï¼‰
- AWS CLIï¼ˆæ¨å¥¨: v2ç³»ï¼‰
- AWS CDK CLIï¼ˆæ¨å¥¨: v2ç³»ã€`npm install -g aws-cdk`ï¼‰
- GitHub CLIï¼ˆ`gh`ã€æ¨å¥¨: v2ç³»ã€`brew install gh` ãªã©ï¼‰
- git

> â€»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ `node -v` `npm -v` `aws --version` `cdk --version` `gh --version` ã§ç¢ºèªã§ãã¾ã™ã€‚
>
> AWSãƒªã‚½ãƒ¼ã‚¹ä½œæˆã«ã¯ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚ä¸è¦ã«ãªã£ãŸãƒªã‚½ãƒ¼ã‚¹ã¯å¿…ãšå‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

---

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ & åˆæœŸåŒ–

```bash
git clone https://github.com/YOUR_NAME/ec2-dev-env-template.git
cd ec2-dev-env-template
npm install
```

---

### 2. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šï¼ˆGitHubï¼‰

| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå          | å†…å®¹                                                                                                                                                                     |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `AWS_ACCESS_KEY_ID`     | IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼                                                                                                                                               |
| `AWS_SECRET_ACCESS_KEY` | åŒä¸Š                                                                                                                                                                     |
| `AWS_REGION`            | ä¾‹ï¼š`ap-northeast-1`                                                                                                                                                     |
| `PROJECT_BUCKET_NAME`   | S3 ãƒã‚±ãƒƒãƒˆåï¼ˆä»»æ„ï¼‰                                                                                                                                                    |
| `GITHUB_TOKEN`          | GitHub CLI/Copilot ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆå¿…é ˆï¼‰                                                                                                                                    |
| `CLAUDE_API_KEY`        | Claude CLI ç”¨ API ã‚­ãƒ¼ï¼ˆä»»æ„ï¼‰                                                                                                                                           |
| `ALLOWED_IP`            | SSH/HTTPS/code-server ã®è¨±å¯ IPï¼ˆCIDR è¡¨è¨˜ï¼‰ã€‚ä¾‹: `203.0.113.1/32`ï¼ˆå˜ä¸€ IP è¨±å¯ï¼‰ã‚„ `0.0.0.0/0`ï¼ˆå…¨ IP è¨±å¯ï¼‰ã€‚è¤‡æ•° IP ã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ CIDR ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æŒ‡å®šã€‚     |
| `SPOT_MAX_PRICE`        | ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ€å¤§ä¾¡æ ¼ï¼ˆUSD/hï¼‰ã€‚ä¾‹: `0.05`ï¼ˆæœ€å¤§ 0.05 USD/h ã¾ã§ï¼‰ã€‚æœªæŒ‡å®šã®å ´åˆã¯ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦èµ·å‹•ã€‚ä¾¡æ ¼ã¯ AWS ã®ã‚¹ãƒãƒƒãƒˆä¾¡æ ¼ã‚’ç¢ºèªã—ã¦è¨­å®šã€‚ |

> âš ï¸ **æ³¨æ„:**
> GitHub Actions ã§ AWS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€å¿…ãšãƒªãƒã‚¸ãƒˆãƒªã®ã€ŒSettings > Secrets and variables > Actions > Secretsã€ã«
> `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION` ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
> `GITHUB_TOKEN` ã¯ EC2 ä¸Šã§ gh/gh copilot CLI ã®èªè¨¼ã«åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
> `CLAUDE_API_KEY` ã¯ Claude CLI åˆ©ç”¨æ™‚ã«å¿…è¦ã§ã™ï¼ˆClaude ã‚’ä½¿ã†å ´åˆã®ã¿ï¼‰ã€‚
> MCPï¼ˆModel Context Protocolï¼‰ã¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜ã§ã‚ã‚Šã€ç‰¹å®šã® CLI ã‚„å…±é€šãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆMCP_TOKENï¼‰ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚åˆ©ç”¨ã—ãŸã„ MCP ã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆä¾‹: GitHub, Notion, DB, Claude Desktop ç­‰ï¼‰ã”ã¨ã«ã€å„å®Ÿè£…ã®å…¬å¼æ‰‹é †ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»è¨­å®šãƒ»èªè¨¼æƒ…å ±ï¼ˆAPI ã‚­ãƒ¼ç­‰ï¼‰ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚
> ã“ã‚Œã‚‰ãŒæœªè¨­å®šã®å ´åˆã€ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚

---

### 2.5. EC2 ã‚­ãƒ¼ãƒšã‚¢ã®ä½œæˆãƒ»SSHæ¥ç¶šæ‰‹é †

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸SSHæ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒšã‚¢ï¼ˆç§˜å¯†éµï¼‰ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§ã”è‡ªèº«ã§ä½œæˆãƒ»è¨­å®šã—ã¦ãã ã•ã„ã€‚

#### 1. ã‚­ãƒ¼ãƒšã‚¢ã®ä½œæˆ

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¾ãŸã¯CLIã§ã‚­ãƒ¼ãƒšã‚¢ï¼ˆ.pemãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
aws ec2 create-key-pair --key-name my-key --query 'KeyMaterial' --output text > my-key.pem
chmod 600 my-key.pem
```

#### 2. CDKã‚¹ã‚¿ãƒƒã‚¯ã§ã‚­ãƒ¼ãƒšã‚¢åã‚’æŒ‡å®š

`lib/dev-env-stack.ts` ã® `ec2.Instance` ä½œæˆæ™‚ã« `keyName` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```ts
const instance = new ec2.Instance(this, 'DevEnvInstance', {
  // ...existing code...
  keyName: 'my-key', // ä½œæˆã—ãŸã‚­ãƒ¼ãƒšã‚¢å
  // ...existing code...
});
```

#### 3. EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„ `aws ec2 describe-instances` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’ç¢ºèªã—ã¾ã™ã€‚

#### 4. SSHæ¥ç¶š

```bash
ssh -i my-key.pem ec2-user@<EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP>
```

> â€» ç§˜å¯†éµï¼ˆ.pemãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯å®‰å…¨ã«ä¿ç®¡ã—ã€ç¬¬ä¸‰è€…ã«æ¸¡ã•ãªã„ã§ãã ã•ã„ã€‚

---

### 2.6. ã‚­ãƒ¼ãƒšã‚¢ï¼ˆ\*.pemãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã®é…ç½®ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ©ç”¨

- ä½œæˆã—ãŸEC2ç”¨ã‚­ãƒ¼ãƒšã‚¢ï¼ˆä¾‹: `my-key.pem`ï¼‰ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã® `keys/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¦ãã ã•ã„ã€‚
- `keys/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ `*.pem` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `.gitignore` ã«ã‚ˆã‚ŠGitç®¡ç†å¯¾è±¡å¤–ã¨ãªã£ã¦ãŠã‚Šã€å…¬é–‹ã•ã‚Œã¾ã›ã‚“ã€‚
- GitHub Actionsç­‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ç§˜å¯†éµã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€`keys/my-key.pem` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

> âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ç§˜å¯†éµã¯çµ¶å¯¾ã«ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚

---

### 3. CLI ãƒ„ãƒ¼ãƒ«ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»èªè¨¼

- EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•æ™‚ã« `gh`ï¼ˆGitHub CLIï¼‰ã€`gh copilot`ã€`claude` CLI ã‚‚è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã« `GITHUB_TOKEN` ã‚„ `CLAUDE_API_KEY` ã‚’è¨˜è¼‰ã—ã¦ãŠãã¨ã€åˆå›èµ·å‹•æ™‚ã«è‡ªå‹•ã§èªè¨¼ãƒ»è¨­å®šã•ã‚Œã¾ã™ã€‚
- Copilot CLI ã¯ `gh` ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
- Claude CLI ã¯ `CLAUDE_API_KEY` ã‚’ `~/.bashrc` ã«è‡ªå‹•ã§è¿½è¨˜ã—ã¾ã™ã€‚
- MCP ã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã¯ã€åˆ©ç”¨ã—ãŸã„ MCP ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å…¬å¼æ‰‹é †ã«å¾“ã„ã€å¿…è¦ãª OSS ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’å„è‡ªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»è¨­å®šã—ã¦ãã ã•ã„ã€‚

---

### 4. CDK æ§‹æˆ

#### `lib/dev-env-stack.ts`

- `t4g.xlarge`ï¼ˆ16GB RAM / Gravitonï¼‰ã‚’ä½¿ç”¨
- 100GB `gp3` EBS
- Amazon Linux 2023 ARM64 AMI
- S3 ã‚¢ã‚¯ã‚»ã‚¹ã€SSM ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª IAM ãƒ­ãƒ¼ãƒ«ä»˜ä¸

#### `user-data.sh`

- `git` / `awscli` / `docker` / `code-server` ãªã©ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- `git worktree` å±•é–‹ç”¨ã®åˆæœŸå‡¦ç†ã‚‚è¿½åŠ å¯

---

### 5. GitHub Actions ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ`.github/workflows/deploy.yml`ï¼‰

```yaml
name: Deploy EC2 Environment

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - run: npm ci
      - run: npx cdk deploy --require-approval never
```

---

## ğŸ’¡ ã‚ˆãã‚ã‚‹ Tips

### ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã—ãŸã„å ´åˆï¼š

- `ec2.Instance` ã«ã‚¹ãƒãƒƒãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
- `instanceMarketOptions` ã‚’æŒ‡å®šï¼ˆå¿…è¦ãªã‚‰ã‚³ãƒ¼ãƒ‰æä¾›ã—ã¾ã™ï¼‰

### è‡ªå‹•åœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼š

- Lambda + EventBridge ã§ 23 æ™‚ã«è‡ªå‹•åœæ­¢ãªã©ã‚‚å¯

### git worktree å¯¾å¿œ:

- `/home/ec2-user/repos` ã«è¤‡æ•°ãƒ–ãƒ©ãƒ³ãƒå±•é–‹
- `user-data.sh`ã§è‡ªå‹•ç”Ÿæˆã‚‚å¯èƒ½

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã® IP åˆ¶é™

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å…¨ IP è¨±å¯ã§ã™ãŒã€`ALLOWED_IP` ç’°å¢ƒå¤‰æ•°ï¼ˆä¾‹: `203.0.113.1/32`ï¼‰ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãã® IP ã®ã¿ SSH/HTTPS/8080 ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚

---

## ğŸ’¸ ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é‹ç”¨

`SPOT_MAX_PRICE` ç’°å¢ƒå¤‰æ•°ã‚’æŒ‡å®šã™ã‚‹ã¨ã€EC2 ãŒã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦èµ·å‹•ã—ã¾ã™ã€‚

- ä¾‹: `SPOT_MAX_PRICE=0.05` ã§æœ€å¤§ 0.05USD/h ã¾ã§
- æœªæŒ‡å®šãªã‚‰ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰

---

## ğŸ›¡ï¸ S3 ãƒã‚±ãƒƒãƒˆæ¨©é™ã®æœ€å°åŒ–

S3 ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ãŸå ´åˆã€IAM ãƒ­ãƒ¼ãƒ«ã«ã¯ãã®ãƒã‚±ãƒƒãƒˆå˜ä½ã®æ¨©é™ã®ã¿ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚

- `AmazonS3FullAccess`ã¯ä¸è¦ã«ãªã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå‘ä¸Šã—ã¾ã™ã€‚
- æ—¢å­˜ãƒã‚±ãƒƒãƒˆã‚’ä½¿ã†å ´åˆã¯ã€å¿…è¦ã«å¿œã˜ã¦æ¨©é™ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

---

## â° EC2 è‡ªå‹•åœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰

ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ã€EventBridge + Lambda ã§è‡ªå‹•åœæ­¢ãŒå¯èƒ½ã§ã™ã€‚

```ts
// CDKä¾‹: æ¯æ—¥23æ™‚ã«EC2ã‚’åœæ­¢
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import * as lambda from 'aws-cdk-lib/aws-lambda';

const stopInstanceFn = new lambda.Function(this, 'StopInstanceFn', {
  runtime: lambda.Runtime.PYTHON_3_11,
  handler: 'index.handler',
  code: lambda.Code.fromInline(`
import boto3
def handler(event, context):
  ec2 = boto3.client('ec2')
  ec2.stop_instances(InstanceIds=['i-xxxxxxxxxxxxxxxxx'])
`),
  environment: { INSTANCE_ID: instance.instanceId },
});
new events.Rule(this, 'StopInstanceRule', {
  schedule: events.Schedule.cron({ minute: '0', hour: '14' }), // UTC+9=23æ™‚
  targets: [new targets.LambdaFunction(stopInstanceFn)],
});
```

### âš ï¸ è‡ªå‹•åœæ­¢æ™‚ã®æ³¨æ„ç‚¹

- è‡ªå‹•åœæ­¢æ™‚ã€EC2 ä¸Šã§å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚„ä½œæ¥­ã¯**å¼·åˆ¶çš„ã«ä¸­æ–­**ã•ã‚Œã¾ã™ã€‚
- ä¿å­˜ã—ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã‚„æœª push ã®ã‚³ãƒ¼ãƒ‰ã¯å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
- é‡è¦ãªä½œæ¥­ã¯**ã“ã¾ã‚ã«ä¿å­˜ãƒ»git/S3 ç­‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**ã—ã¦ãã ã•ã„ã€‚
- ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚‚åŒæ§˜ã«ã€AWS å´éƒ½åˆã§ä¸­æ–­ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

---

## ğŸ›¡ï¸ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

- `ALLOWED_IP`ï¼ˆCIDRå½¢å¼ï¼‰ã‚„ `PROJECT_BUCKET_NAME`ï¼ˆS3å‘½åè¦å‰‡ï¼‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’CDKã§è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
- ä¸æ­£ãªå€¤ã®å ´åˆã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
- EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯Nameã‚¿ã‚°ãŒè‡ªå‹•ä»˜ä¸ã•ã‚Œã¾ã™ã€‚

## ğŸ§ª å“è³ªãƒ»CI/CDå¼·åŒ–

- `eslint`/`prettier`/`jest`ã«ã‚ˆã‚‹é™çš„è§£æãƒ»è‡ªå‹•æ•´å½¢ãƒ»ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚
- `npm run lint`/`npm run format`/`npm test` ã§å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¯èƒ½ã§ã™ã€‚
- GitHub Actionsã§ã‚‚è‡ªå‹•ã§lint/testãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

---

## ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤

- ä¸è¦ã«ãªã£ãŸEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚„EBSã€S3ãƒã‚±ãƒƒãƒˆç­‰ã¯AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„ `cdk destroy` ã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
- `cdk destroy` ã§CDKã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚
- S3ãƒã‚±ãƒƒãƒˆã‚„IAMãƒ­ãƒ¼ãƒ«ãªã©ä¸€éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã¯æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
- å‰Šé™¤æ¼ã‚ŒãŒã‚ã‚‹ã¨ã‚³ã‚¹ãƒˆãŒç¶™ç¶šç™ºç”Ÿã™ã‚‹ãŸã‚ã€å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚

---

## ğŸ§™â€â™€ï¸ ã¾ã¨ã‚

> ğŸ’ Graviton ã§çˆ†é€Ÿï¼†æ¿€å®‰ã€S3 ã‚‚ SSM ã‚‚ä½¿ãˆã¦ã€git worktree ã§ä¸¦åˆ—ä½œæ¥­ã‚‚ OKï¼
>
> â³ CloudWatch ã§ CPU ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã‚’æ¤œçŸ¥ã—ã€Lambda ã§ EC2 ã‚’è‡ªå‹•åœæ­¢ã™ã‚‹ã“ã¨ã§ã€Œä½¿ã£ãŸåˆ†ã ã‘ã€å®‰ä¾¡ã«é‹ç”¨ã§ãã¾ã™ã€‚
> ä¾‹: 30åˆ†é–“ CPU åˆ©ç”¨ç‡ãŒ 5% æœªæº€ãªã‚‰è‡ªå‹•åœæ­¢ã€‚åœæ­¢å¾Œã‚‚ EBS ä¸Šã«ä½œæ¥­å†…å®¹ã¯ä¿æŒã•ã‚Œã€å†èµ·å‹•ã§ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ å¯èƒ½ã§ã™ã€‚
> tmux ã‚„ screen ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã€S3/EBS ã§ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã‚‚æ¨å¥¨ã€‚
> è©³ç´°ãªè‡ªå‹•åœæ­¢è¨­å®šä¾‹ã¯ AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ CDK ã‚µãƒ³ãƒ—ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
> å®Œå…¨ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ã§ã€é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰ãŒã€Œãƒœã‚¿ãƒ³ã²ã¨ã¤ã€ã§ã§ãã‚‹ä¸–ç•Œã‚’å®Ÿç¾ã—ã¾ã™ âœ¨

---

## ğŸ’° ã‚³ã‚¹ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä»£è¡¨çš„ãªAWSãƒªã‚½ãƒ¼ã‚¹æ§‹æˆï¼ˆEC2 t4g.xlarge, 100GB gp3 EBS, æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç­‰ï¼‰ã¯ã€
[AWS Pricing Calculatorã®å…±æœ‰è¦‹ç©ã‚‚ã‚Šãƒªãƒ³ã‚¯](https://calculator.aws/#/estimate?id=68ab2b06136098be931a29dcc0b963da7253358d) ã‹ã‚‰ã€
ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«ã‚³ã‚¹ãƒˆè©¦ç®—ã§ãã¾ã™ã€‚

> â€» å®Ÿéš›ã®åˆ©ç”¨çŠ¶æ³ã‚„è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹ã«å¿œã˜ã¦é‡‘é¡ã¯å¤‰å‹•ã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦è¦‹ç©ã‚‚ã‚Šå†…å®¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚

---

## ğŸ›¡ï¸ å¿…è¦ãª AWS æ¨©é™ï¼ˆãƒãƒªã‚·ãƒ¼ä¾‹ï¼‰

CDK ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„ EC2 ç’°å¢ƒæ§‹ç¯‰ã«å¿…è¦ãªæœ€å°é™ã®æ¨©é™ä¾‹ã§ã™ã€‚IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ GitHub Actions ç”¨ãƒ­ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚

### ç®¡ç†ãƒãƒªã‚·ãƒ¼ä¾‹ï¼ˆJSONï¼‰

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:*",
        "iam:PassRole",
        "iam:GetRole",
        "iam:CreateRole",
        "iam:AttachRolePolicy",
        "iam:PutRolePolicy",
        "cloudformation:*",
        "ssm:*",
        "s3:*",
        "logs:*",
        "ecs:*", // ECS CLI, CDK ã§ ECS ã‚’ä½¿ã†å ´åˆ
        "eks:*", // eksctl, CDK ã§ EKS ã‚’ä½¿ã†å ´åˆ
        "lambda:*", // SAM CLI, CDK ã§ Lambda ã‚’ä½¿ã†å ´åˆ
        "cloudwatch:*" // CloudWatch Logs, Events ãªã©
      ],
      "Resource": "*"
    }
  ]
}
```

- **æœ€å°æ¨©é™é‹ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚**
- S3 ãƒã‚±ãƒƒãƒˆåã‚„ãƒªã‚½ãƒ¼ã‚¹ã‚’é™å®šã™ã‚‹å ´åˆã¯ `"Resource"` ã‚’é©å®œåˆ¶é™ã—ã¦ãã ã•ã„ã€‚
- `iam:PassRole` ã«ã¯ CDK ã§ä½œæˆã™ã‚‹ãƒ­ãƒ¼ãƒ«ã® ARN ã‚’æŒ‡å®šã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã§ã™ã€‚
- ECS/EKS/Lambda/SAM/CloudWatch ãªã© AWS ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€å¿…è¦ã«å¿œã˜ã¦è©²å½“ã‚µãƒ¼ãƒ“ã‚¹ã®æ¨©é™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“ EC2æ¥ç¶šæƒ…å ±CSVå‡ºåŠ›ã«ã¤ã„ã¦

CDKãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã€EC2ã¸ã®æ¥ç¶šæƒ…å ±ã‚’ `ec2-connection-info.csv` ã¨ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã¯è‡ªå‹•ç”Ÿæˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ï¼š

### CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹

| InstanceId | PublicIp     | User     | KeyName | Region         | SSHCommand                                     | CreatedAt            |
| ---------- | ------------ | -------- | ------- | -------------- | ---------------------------------------------- | -------------------- |
| i-xxxxxxxx | 203.0.113.10 | ec2-user | my-key  | ap-northeast-1 | "ssh -i keys/my-key.pem ec2-user@203.0.113.10" | 2025-05-31T12:34:56Z |

```csv
InstanceId,PublicIp,User,KeyName,Region,SSHCommand,CreatedAt
i-xxxxxxxx,203.0.113.10,ec2-user,my-key,ap-northeast-1,"ssh -i keys/my-key.pem ec2-user@203.0.113.10",2025-05-31T12:34:56Z
```

- `User` ã¯ Amazon Linux ã®å ´åˆ `ec2-user` ã§ã™ã€‚
- `KeyName` ã¯CDKã§æŒ‡å®šã—ãŸã‚­ãƒ¼ãƒšã‚¢åã€‚
- `SSHCommand` ã¯å®Ÿéš›ã®æ¥ç¶šã‚³ãƒãƒ³ãƒ‰ä¾‹ã€‚
- `CreatedAt` ã¯å‡ºåŠ›æ™‚ã®UTCæ—¥æ™‚ã€‚

> ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `.gitignore` ã«ã‚ˆã‚ŠGitç®¡ç†å¯¾è±¡å¤–ã§ã™ã€‚

---
